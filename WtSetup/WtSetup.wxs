<?xml version="1.0"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
   <Product Id="*"
            Name="WindowTabs"
            Language="1033"
            Version="25.11.10.0"
            Manufacturer="Satoshi Yamamoto (standard-software)"
            UpgradeCode="6763D234-BCFA-4172-8190-756DEE9CF2B1">

      <Package Compressed="yes"
               InstallerVersion="200"
               Platform="x64"
               Description="WindowTabs Installer"
               Comments="Brings browser-style tabbed window management to the desktop" />

      <Media Id="1" Cabinet="product.cab" EmbedCab="yes"/>

      <!-- Upgrade settings -->
      <MajorUpgrade DowngradeErrorMessage="A newer version of WindowTabs is already installed." />

      <!-- Installation directory structure -->
      <Directory Id="TARGETDIR" Name="SourceDir">
         <Directory Id="ProgramFiles64Folder">
            <Directory Id="INSTALLFOLDER" Name="WindowTabs">
               <Component Id="MainExecutable" Guid="3C67513D-01DD-4637-8A68-80971EB9504F" Win64="yes">
                  <!-- Main executable -->
                  <File Id="WindowTabsExe"
                        Source="$(var.WtProgram.TargetDir)WindowTabs.exe"
                        KeyPath="yes" />

                  <!-- Configuration file -->
                  <File Id="WindowTabsConfig"
                        Source="$(var.WtProgram.TargetDir)WindowTabs.exe.config" />

                  <!-- Required DLL files -->
                  <File Id="Win32Dll"
                        Source="$(var.WtProgram.TargetDir)Win32.dll" />
                  <File Id="AgaControlsDll"
                        Source="$(var.WtProgram.TargetDir)Aga.Controls.dll" />
                  <File Id="NewtonsoftJsonDll"
                        Source="$(var.WtProgram.TargetDir)Newtonsoft.Json.dll" />
                  <File Id="FSharpCoreDll"
                        Source="$(var.WtProgram.TargetDir)FSharp.Core.dll" />
                  <File Id="FSharpPowerPackDll"
                        Source="$(var.WtProgram.TargetDir)FSharp.PowerPack.dll" />
                  <File Id="FSharpPowerPackLinqDll"
                        Source="$(var.WtProgram.TargetDir)FSharp.PowerPack.Linq.dll" />
                  <File Id="FSharpPowerPackMetadataDll"
                        Source="$(var.WtProgram.TargetDir)FSharp.PowerPack.Metadata.dll" />
                  <File Id="FSharpPowerPackParallelSeqDll"
                        Source="$(var.WtProgram.TargetDir)FSharp.PowerPack.Parallel.Seq.dll" />
                  <File Id="InteropSHDocVwDll"
                        Source="$(var.WtProgram.TargetDir)Interop.SHDocVw.dll" />
                  <File Id="InteropShell32Dll"
                        Source="$(var.WtProgram.TargetDir)Interop.Shell32.dll" />
               </Component>

               <!-- Registry entries for uninstall -->
               <Component Id="RegistryEntries" Guid="A5B2E1C3-4D6F-7890-ABCD-EF1234567890" Win64="yes">
                  <RegistryKey Root="HKCU"
                               Key="Software\WindowTabs"
                               ForceDeleteOnUninstall="yes">
                     <RegistryValue Type="string"
                                    Name="InstallPath"
                                    Value="[INSTALLFOLDER]"
                                    KeyPath="yes"/>
                  </RegistryKey>
               </Component>
            </Directory>
         </Directory>

         <!-- Start Menu -->
         <Directory Id="ProgramMenuFolder">
            <Directory Id="ApplicationProgramsFolder" Name="WindowTabs">
               <Component Id="ApplicationShortcut" Guid="B6C3F2E4-5D7A-8901-BCDE-EF2345678901" Win64="yes">
                  <Shortcut Id="ApplicationStartMenuShortcut"
                           Name="WindowTabs"
                           Description="Browser-style tabbed window management"
                           Target="[INSTALLFOLDER]WindowTabs.exe"
                           WorkingDirectory="INSTALLFOLDER"
                           Icon="BemoIcon.ico" />

                  <RemoveFolder Id="CleanUpShortCut"
                                Directory="ApplicationProgramsFolder"
                                On="uninstall"/>

                  <RegistryValue Root="HKCU"
                                 Key="Software\WindowTabs"
                                 Name="StartMenuShortcut"
                                 Type="integer"
                                 Value="1"
                                 KeyPath="yes"/>
               </Component>
            </Directory>
         </Directory>

         <!-- Desktop Shortcut (optional) -->
         <Directory Id="DesktopFolder" Name="Desktop">
            <Component Id="DesktopShortcut" Guid="C7D4E3F5-6E8B-9012-CDEF-EA3456789012" Win64="yes">
               <Shortcut Id="DesktopShortcutIcon"
                        Name="WindowTabs"
                        Description="Browser-style tabbed window management"
                        Target="[INSTALLFOLDER]WindowTabs.exe"
                        WorkingDirectory="INSTALLFOLDER"
                        Icon="BemoIcon.ico" />

               <RegistryValue Root="HKCU"
                              Key="Software\WindowTabs"
                              Name="DesktopShortcut"
                              Type="integer"
                              Value="1"
                              KeyPath="yes"/>
            </Component>
         </Directory>
      </Directory>

      <!-- Icon definition -->
      <Icon Id="BemoIcon.ico" SourceFile="..\WtProgram\Resources\Bemo.ico"/>
      <Property Id="ARPPRODUCTICON" Value="BemoIcon.ico" />

      <!-- Launch application after installation -->
      <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch WindowTabs" />
      <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1" />

      <CustomAction Id="LaunchApplication"
                    FileKey="WindowTabsExe"
                    ExeCommand=""
                    Execute="immediate"
                    Impersonate="yes"
                    Return="asyncNoWait" />

      <!-- Close running WindowTabs before installation -->
      <util:CloseApplication Id="CloseWindowTabs"
                              Target="WindowTabs.exe"
                              CloseMessage="yes"
                              Description="WindowTabs is currently running. Click OK to close it and continue installation, or Cancel to exit."
                              RebootPrompt="no"
                              TerminateProcess="0"
                              Timeout="5" />

      <!-- Features -->
      <Feature Id="MainApplication"
               Title="WindowTabs"
               Description="Main application files"
               Level="1"
               ConfigurableDirectory="INSTALLFOLDER">
         <ComponentRef Id="MainExecutable"/>
         <ComponentRef Id="RegistryEntries"/>
         <ComponentRef Id="ApplicationShortcut"/>
      </Feature>

      <Feature Id="DesktopShortcutFeature"
               Title="Desktop Shortcut"
               Description="Create a desktop shortcut"
               Level="1">
         <ComponentRef Id="DesktopShortcut"/>
      </Feature>

      <!-- Basic UI with installation directory selection -->
      <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />

      <UI>
         <UIRef Id="WixUI_InstallDir" />

         <!-- Skip License Agreement Dialog -->
         <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg" Order="2">1</Publish>
         <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg" Order="2">1</Publish>

         <!-- Launch application on finish -->
         <Publish Dialog="ExitDialog"
                  Control="Finish"
                  Event="DoAction"
                  Value="LaunchApplication">WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed</Publish>
      </UI>

   </Product>
</Wix>
